# AI宠物冒险项目上下文

## 项目概述
AI宠物冒险是一个基于Next.js的交互式宠物养成游戏，使用AI对话来驱动游戏进程。

## 技术栈
- **前端框架**: Next.js 14.2.31
- **样式**: Tailwind CSS
- **AI服务**: Deepseek API
- **部署平台**: Vercel
- **代码仓库**: GitHub

## 当前部署状态
- **生产环境**: https://ai-pet-adventure-qobjtk7rz-freedomztm-7943s-projects.vercel.app
- **GitHub仓库**: https://github.com/frankzhi/ai-pet-adventure.git
- **最后部署时间**: 2025-08-22 07:41:33 UTC
- **最后提交**: c640534 - 新增突变溢出系统：突变值满时立即清零并生成词条，70%概率负面词条影响宠物特性

## 最近优化内容

### 突变溢出系统 (2025-08-22)
- **功能**: 当突变值达到100时，立即清空为0并生成新词条
- **词条生成**: 70%概率生成负面词条，30%概率生成正面词条
- **词条效果**: 影响宠物的心情、能量、健康值，并改变其特性和行为
- **负面词条**: 易怒、能量紊乱、脆弱、偏执、交流迟缓等
- **正面词条**: 冷静、体质强化、精力充沛、灵感闪现、社交直觉等
- **触发路径**: 对话互动、任务完成、时间累积、随机事件后都会检查突变溢出
- **事件记录**: 突变溢出事件会记录到活动日志和故事中

### 关键错误修复 (2025-08-20)
- **问题**: 时间处理错误导致getTime is not a function，任务无法正常完成
- **解决方案**: 
  - 修复时间处理：确保所有时间字段正确转换为Date对象，避免getTime错误
  - 修复任务完成逻辑：确保正确调用GameService.startTask，任务状态正确保存
  - 修复突变检查：修复lastMutationCheck等时间字段的处理
  - 修复随机事件：修复randomEvents中时间戳的处理
  - 修复宠物活动：修复lastActivityUpdate等时间字段的处理
  - 改善错误处理：添加任务开始的错误提示

### 布局优先级和位置优化 (2025-08-20)
- **问题**: 对话互动重要性被低估，详细信息位置遮挡其他内容，存在重复信息
- **解决方案**: 
  - 调整布局优先级：对话互动移到第一行右侧，占用2列空间，更重要
  - 优化位置关系：状态面板1列，对话互动2列，任务列表全宽，事件日志简化
  - 移除重复信息：删除PetStatus组件中的详细信息折叠区域
  - 避免遮挡问题：重新设计各模块位置，确保不会相互遮挡
  - 简化事件日志：只保留事件日志，移除重复的故事背景信息
  - 改善用户体验：对话互动更突出，任务列表更清晰

### AI响应JSON解析修复 (2025-08-20)
- **问题**: AI返回的JSON响应包含markdown代码块标记（```json），导致JSON.parse解析失败
- **解决方案**: 
  - 添加cleanAIResponse通用函数清理markdown标记
  - 修复所有JSON.parse调用点
  - 统一处理AI响应的格式清理
  - 增强错误处理和容错机制

### PC端布局适配优化 (2025-08-20)
- **问题**: 状态面板在PC端屏幕上被过度拉长，导致页面布局分割，视觉不平衡
- **解决方案**: 
  - 重构PetStatus组件为紧凑布局设计
  - 移除两列网格布局，改为单列紧凑布局
  - 优化元素尺寸：头像、字体、进度条、图标等
  - 添加可折叠详细信息区域
  - 改进视觉层次和信息密度

### 核心功能优化
- AI对话状态分析优化 - 更严谨的状态变化逻辑
- 核心问题修复 - AI返回的是变化量，需要累加而不是替换
- 任务描述润色 - 移除系统化描述文本
- UI布局重构 - 三栏布局，减少tab切换

## 项目结构
```
/Users/franktianmuzhi/ai-pet-adventure/
├── components/          # React组件
│   ├── PetGame.tsx     # 主游戏界面
│   ├── PetStatus.tsx   # 宠物状态面板 (已优化)
│   ├── TaskList.tsx    # 任务列表
│   ├── ChatInterface.tsx # 对话界面
│   └── EventLog.tsx    # 事件日志
├── lib/                # 核心逻辑
│   ├── game-service.ts # 游戏服务 (新增突变溢出系统)
│   └── ai-service.ts   # AI服务
├── types/              # TypeScript类型定义
└── app/                # Next.js应用路由
```

## 部署流程
1. 代码修改完成后提交到Git
2. 推送到GitHub仓库
3. 使用Vercel CLI部署到生产环境
4. 更新项目上下文文档

## 关键文件
- `/Users/franktianmuzhi/ai-pet-adventure/components/PetGame.tsx` - 主UI布局
- `/Users/franktianmuzhi/ai-pet-adventure/lib/game-service.ts` - 游戏逻辑 (新增突变溢出处理)
- `/Users/franktianmuzhi/ai-pet-adventure/lib/ai-service.ts` - AI服务

## 下一步计划
- 继续优化移动端体验
- 添加更多宠物类型和互动方式
- 优化AI对话的响应速度和质量
- 增加游戏统计和分析功能
- 扩展突变词条系统，增加更多词条类型和效果

## 注意事项
- 确保所有代码更改都同步到GitHub仓库
- 部署前进行本地测试
- 保持项目上下文文档的更新
- 遵循标准化部署流程
- 突变溢出系统会影响宠物的长期特性，需要平衡游戏性
